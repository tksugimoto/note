<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<link rel="icon" href="./icons/144.png">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="./js/install-service-worker.js"></script>
	<link rel="manifest" href="./manifest.json">
	<title>Share Page</title>
	<style>
		li {
			padding: 10px 0;
		}
		dd {
			white-space: pre;
		}
		button {
			cursor: pointer;
			padding: 10px;
		}
	</style>
</head>
<body>
<h2>Share Page</h2>
<dl id="dl"></dl>
<ul id="share-buttons"></ul>
<script>
{
	const searchParams = new URL(document.URL).searchParams;
	const title = searchParams.get('title');
	const text = searchParams.get('text');
	const url = searchParams.get('url');

	document.title += `: ${title || text}`;

	const dl = document.getElementById('dl');
	Object.entries({
		title,
		text,
		url,
	}).forEach(([key, value]) => {
		const dt = document.createElement('dt');
		dt.append(key);
		const dd = document.createElement('dd');
		dd.append(value);
		dl.append(dt, dd);
	});

	const parsedUrl = (() => {
		try {
			return new URL(url || text);
		} catch(e) {
			return null;
		}
	})();
	const isUrl = Boolean(parsedUrl && parsedUrl.hostname);
	const shareButtons = document.getElementById('share-buttons');
	[{
		name: 'クリップボードにコピー',
		enabled: Boolean(navigator.clipboard),
		callback: () => {
			navigator.clipboard.writeText([title, text, url].filter(Boolean).join('\n'));
		},
	}, {
		name: '別アプリに共有',
		enabled: Boolean(navigator.share),
		callback: () => {
			navigator.share({
				text: [title, text, url].filter(Boolean).join('\n'),
			});
		},
	}, {
		name: 'Twitterで共有',
		enabled: true,
		callback: () => {
			const params = new URLSearchParams({
				text: [title, text, url].filter(Boolean).join('\n'),
			});
			window.open(`https://twitter.com/intent/tweet?${params.toString()}`);
		},
	}, {
		name: 'Google カレンダーに登録',
		enabled: true,
		callback: () => {
			const params = new URLSearchParams({
				action: 'TEMPLATE',
				text: title,
				details: [text, url].filter(Boolean).join('\n'),
			});
			window.open(`http://www.google.com/calendar/event?${params.toString()}`);
		},
	}, {
		name: 'タイトル で Google検索',
		enabled: Boolean(title),
		callback: () => {
			const params = new URLSearchParams({
				q: title,
			});
			window.open(`https://www.google.com/search?${params.toString()}`);
		},
	}, {
		name: 'テキスト で Google検索',
		enabled: Boolean(text),
		callback: () => {
			const params = new URLSearchParams({
				q: text.replace(/\n/g, ' '),
			});
			window.open(`https://www.google.com/search?${params.toString()}`);
		},
	}, {
		name: '[URL] hostname をコピ－',
		enabled: isUrl && Boolean(navigator.clipboard),
		callback: () => {
			navigator.clipboard.writeText(parsedUrl.hostname);
		},
	}, {
		name: '[URL] pathname をコピ－',
		enabled: isUrl && Boolean(navigator.clipboard),
		callback: () => {
			navigator.clipboard.writeText(parsedUrl.pathname);
		},
	}, {
		name: '[URL] query, hash を削除してコピ－',
		enabled: isUrl && Boolean(navigator.clipboard),
		callback: () => {
			const _url = new URL(parsedUrl);
			_url.search = '';
			_url.hash = '';
			navigator.clipboard.writeText(_url.href);
		},
	}].forEach(({name, callback, enabled}) => {
		if (!enabled) return;
		const li = document.createElement('li');
		const button = document.createElement('button');
		button.innerText = name;
		button.addEventListener('click', callback);
		li.append(button);
		shareButtons.append(li);
	});
}
</script>
</body>
